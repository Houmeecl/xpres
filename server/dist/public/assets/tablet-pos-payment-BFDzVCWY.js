import{r as m,j as e,aG as ne,u as ce,_ as le,ap as I,B as i,F as ie,K as J,a as K,b as Q,d as G,e as W,T as oe,i as de,k as L,M as C,n as k,bw as me,C as H,$ as E,I as A,a5 as xe,al as pe,am as he,ao as ue,bx as je,ba as ge,X as Y,x as fe}from"./index-Bdt7aQY8.js";import{S as Z,P as ee,I as Ne}from"./IdentityVerification-CHyRbnlX.js";import{L as ye}from"./scan-C9uXCfh4.js";function be({amount:x,currency:$,intent:P}){const S=async()=>({orderId:(await(await fetch("/order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:x,currency:$,intent:P})})).json()).id}),o=async t=>await(await fetch(`/order/${t}/capture`,{method:"POST",headers:{"Content-Type":"application/json"}})).json(),n=async t=>{console.log("onApprove",t);const l=await o(t.orderId);console.log("Capture result",l)},u=async t=>{console.log("onCancel",t)},r=async t=>{console.log("onError",t)};m.useEffect(()=>{(async()=>{try{if(window.paypal)await h();else{const l=document.createElement("script");l.src="https://www.paypal.com/web-sdk/v6/core",l.async=!0,l.onload=()=>h(),document.body.appendChild(l)}}catch(l){console.error("Failed to load PayPal SDK",l)}})()},[]);const h=async()=>{try{const t=await fetch("/setup").then(p=>p.json()).then(p=>p.clientToken),j=(await window.paypal.createInstance({clientToken:t,components:["paypal-payments"]})).createPayPalOneTimePaymentSession({onApprove:n,onCancel:u,onError:r}),y=async()=>{try{const p=S();await j.start({paymentFlow:"auto"},p)}catch(p){console.error(p)}},f=document.getElementById("paypal-button");return f&&f.addEventListener("click",y),()=>{f&&f.removeEventListener("click",y)}}catch(t){console.error(t)}};return e.jsx("paypal-button",{id:"paypal-button"})}const Pe=()=>{const{toast:x}=ne(),[$,P]=ce(),[S,o]=m.useState("services"),[n,u]=m.useState([]),[r,h]=m.useState({name:"",email:"",document:""}),[t,l]=m.useState("cash"),[j,y]=m.useState(!1),[f,p]=m.useState(!1),[O,v]=m.useState(null),[V,g]=m.useState(null),[se,_]=m.useState(!1),[N,D]=m.useState(null),T=n.reduce((s,a)=>s+a.price*a.quantity,0),M=T*ee.TAX_RATE,R=T+M;m.useEffect(()=>{const s=new URLSearchParams(window.location.search),a=s.get("status"),c=s.get("reference");if(a&&c&&c.startsWith("TX-TABLET-")){if(v(c),!r.name||!r.email)try{const d=localStorage.getItem(`tx_customer_${c}`);d&&h(JSON.parse(d))}catch(d){console.error("Error recuperando datos del cliente:",d)}if(n.length===0)try{const d=localStorage.getItem(`tx_cart_${c}`);d&&u(JSON.parse(d))}catch(d){console.error("Error recuperando items del carrito:",d)}a==="success"||a==="approved"?(p(!0),x({title:"Pago completado",description:`Transacción ${c} procesada exitosamente`})):a==="pending"?(o("payment"),g("Tu pago está en proceso de verificación. Una vez confirmado, actualizaremos el estado de tu transacción. No es necesario realizar el pago nuevamente."),x({title:"Pago pendiente",description:"El pago está en proceso de verificación",variant:"default"})):(o("payment"),g("El pago no pudo ser procesado. Por favor intente nuevamente o elija otro método de pago."),x({title:"Pago fallido",description:"No se pudo completar la transacción",variant:"destructive"}));const w=window.location.pathname;window.history.replaceState({},document.title,w)}},[]);const F=T.toLocaleString("es-CL",{style:"currency",currency:"CLP"}),U=M.toLocaleString("es-CL",{style:"currency",currency:"CLP"}),q=R.toLocaleString("es-CL",{style:"currency",currency:"CLP"}),ae=s=>{const a=n.find(c=>c.id===s.id);u(a?n.map(c=>c.id===s.id?{...c,quantity:c.quantity+1}:c):[...n,{...s,quantity:1}]),x({title:"Servicio agregado",description:`${s.name} agregado al carrito`})},B=s=>{u(n.filter(a=>a.id!==s))},X=(s,a)=>{if(a<=0){B(s);return}u(n.map(c=>c.id===s?{...c,quantity:a}:c))},te=async()=>{if(n.length===0){g("No hay items en el carrito");return}if(!r.name||!r.email){g("Por favor complete la información del cliente"),o("customer");return}y(!0),g(null);try{if(t==="mercadopago"){const s=n.map(b=>({title:b.name,quantity:b.quantity,unit_price:b.price,currency_id:"CLP"})),a=`TX-TABLET-${Date.now().toString()}`;try{localStorage.setItem(`tx_customer_${a}`,JSON.stringify(r)),localStorage.setItem(`tx_cart_${a}`,JSON.stringify(n))}catch(b){console.error("Error guardando datos del cliente:",b)}const c={success:`${window.location.origin}/tablet-pos-payment?status=success&reference=${a}`,failure:`${window.location.origin}/tablet-pos-payment?status=failure&reference=${a}`,pending:`${window.location.origin}/tablet-pos-payment?status=pending&reference=${a}`},w=await fetch("/api/payments/create-preference",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:s,backUrls:c,externalReference:a,identification:{type:"RUT",number:r.document}})});if(!w.ok)throw new Error("Error al crear preferencia de pago");const d=await w.json();if(v(a),d.init_point){window.location.href=d.init_point;return}else throw new Error("No se recibió URL de pago")}else{await new Promise(a=>setTimeout(a,2e3));const s="TX-"+Date.now().toString().slice(-6);v(s),p(!0),x({title:"Pago completado",description:`Transacción ${s} procesada exitosamente`})}}catch(s){console.error("Error procesando el pago:",s),g("Error al procesar el pago. Intente nuevamente."),x({title:"Error",description:"No se pudo completar la transacción",variant:"destructive"})}finally{y(!1)}},z=()=>{u([]),h({name:"",email:"",document:""}),l("cash"),p(!1),v(null),g(null),_(!1),D(null),o("services")},re=()=>e.jsxs("div",{className:"bg-white p-6 rounded-lg border",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx("h3",{className:"text-xl font-bold",children:"Recibo de Pago"}),e.jsx("p",{className:"text-gray-500",children:"VecinoXpress"}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Transacción #",O]}),e.jsx("p",{className:"text-sm text-gray-400",children:new Date().toLocaleString()})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Cliente"}),e.jsx("p",{children:r.name}),e.jsx("p",{className:"text-sm text-gray-500",children:r.email}),r.document&&e.jsxs("p",{className:"text-sm text-gray-500",children:["RUT: ",r.document]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"font-medium mb-2",children:"Items"}),n.map(s=>e.jsxs("div",{className:"flex justify-between py-1 text-sm",children:[e.jsxs("span",{children:[s.quantity," x ",s.name]}),e.jsx("span",{children:(s.price*s.quantity).toLocaleString("es-CL",{style:"currency",currency:"CLP"})})]},s.id))]}),e.jsx(Y,{className:"my-4"}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:F})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"IVA (19%)"}),e.jsx("span",{children:U})]}),e.jsxs("div",{className:"flex justify-between font-bold mt-2",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:q})]})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t text-center",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center mb-4",children:[e.jsx(I,{className:"w-10 h-10 text-green-500 mb-2"}),e.jsx("p",{className:"text-green-600 font-medium",children:"Pago Completado"})]}),e.jsx("p",{className:"text-sm text-gray-500",children:"Gracias por utilizar VecinoXpress"})]})]});return e.jsx("div",{className:"min-h-screen bg-gray-50 p-4 md:p-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("button",{onClick:()=>P("/"),className:"mr-4 flex items-center justify-center w-10 h-10 rounded-full bg-white shadow hover:bg-gray-100",children:e.jsx(le,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-2xl font-bold text-[#2d219b]",children:"VecinoXpress Tablet POS"})]}),e.jsx("div",{className:"text-sm bg-[#2d219b] text-white px-3 py-1 rounded-full",children:"Versión Tablet (Web)"})]}),f?e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"md:col-span-2 bg-white p-6 rounded-lg shadow text-center mb-4",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(I,{className:"w-8 h-8 text-green-600"})}),e.jsx("h2",{className:"text-xl font-semibold text-green-700 mb-2",children:"¡Transacción Completada!"}),e.jsxs("p",{className:"text-gray-600 mb-6",children:["La transacción #",O," ha sido procesada exitosamente."]}),e.jsx(i,{onClick:z,children:"Nueva Transacción"})]}),e.jsx("div",{className:"col-span-1",children:re()}),e.jsxs("div",{className:"col-span-1 bg-white p-6 rounded-lg shadow",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"¿Qué desea hacer ahora?"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(i,{variant:"outline",className:"w-full justify-start text-left",onClick:()=>{x({title:"Imprimir recibo",description:"Funcionalidad en desarrollo"})},children:[e.jsx(ie,{className:"w-4 h-4 mr-2"}),"Imprimir recibo"]}),e.jsxs(i,{variant:"outline",className:"w-full justify-start text-left",onClick:()=>{x({title:"Enviar por correo",description:"Funcionalidad en desarrollo"})},children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Enviar por correo"]}),e.jsxs(i,{className:"w-full justify-start text-left",onClick:z,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Nueva venta"]})]})]})]}):e.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs(K,{className:"shadow",children:[e.jsx(Q,{className:"bg-gradient-to-r from-[#2d219b]/10 to-[#2d219b]/5",children:e.jsx(G,{children:"Terminal de Servicios"})}),e.jsx(W,{className:"p-0",children:e.jsxs(oe,{value:S,onValueChange:o,className:"w-full",children:[e.jsxs(de,{className:"w-full grid grid-cols-3",children:[e.jsxs(L,{value:"services",children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Servicios"]}),e.jsxs(L,{value:"customer",children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Cliente"]}),e.jsxs(L,{value:"payment",disabled:n.length===0,children:[e.jsx(C,{className:"w-4 h-4 mr-2"}),"Pago"]})]}),e.jsxs(k,{value:"services",className:"p-6",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Seleccione los servicios"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:ee.AVAILABLE_SERVICES.map(s=>e.jsx("div",{className:"border rounded-lg p-3 hover:bg-gray-50 cursor-pointer",onClick:()=>ae(s),children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.price.toLocaleString("es-CL",{style:"currency",currency:"CLP"})})]}),e.jsx(i,{size:"sm",variant:"ghost",children:e.jsx(me,{className:"w-4 h-4"})})]})},s.id))}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsxs(i,{disabled:n.length===0,onClick:()=>o("customer"),children:["Siguiente",e.jsx(H,{className:"ml-2 h-4 w-4"})]})})]}),e.jsxs(k,{value:"customer",className:"p-6",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Información del cliente"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{htmlFor:"name",children:"Nombre completo"}),e.jsx(A,{id:"name",value:r.name,onChange:s=>h({...r,name:s.target.value}),placeholder:"Nombre del cliente"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{htmlFor:"email",children:"Correo electrónico"}),e.jsx(A,{id:"email",type:"email",value:r.email,onChange:s=>h({...r,email:s.target.value}),placeholder:"correo@ejemplo.com"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{htmlFor:"document",children:"RUT (opcional)"}),e.jsx(A,{id:"document",value:r.document,onChange:s=>h({...r,document:s.target.value}),placeholder:"12.345.678-9"})]})]}),e.jsxs("div",{className:"mt-6 pt-4 border-t",children:[e.jsx("h3",{className:"text-lg font-medium mb-4",children:"Verificación de Identidad"}),se?e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 flex items-start",children:[e.jsx(I,{className:"text-green-600 w-5 h-5 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-800",children:"Identidad Verificada"}),N&&e.jsxs("div",{className:"mt-2 text-sm text-green-700",children:[e.jsxs("p",{children:["Nombre: ",N.fullName]}),e.jsxs("p",{children:["Documento: ",N.documentNumber]}),e.jsxs("p",{children:["Método: ",N.verificationMethod==="simulate"?"Simulado":N.verificationMethod==="nfc"?"NFC":N.verificationMethod==="document"?"Documento":"Selfie"]})]})]})]}):e.jsx(Ne,{onVerificationComplete:s=>{_(!0),D(s),h({...r,name:s.fullName,document:s.documentNumber}),x({title:"Identidad verificada",description:"La información ha sido verificada exitosamente."})},mode:"simple"})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx(i,{variant:"outline",onClick:()=>o("services"),children:"Atrás"}),e.jsxs(i,{onClick:()=>o("payment"),disabled:!r.name||!r.email,children:["Siguiente",e.jsx(H,{className:"ml-2 h-4 w-4"})]})]})]}),e.jsxs(k,{value:"payment",className:"p-6",children:[e.jsx("h3",{className:"font-medium mb-4",children:"Método de pago"}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer ${t==="cash"?"border-[#2d219b] bg-[#2d219b]/5":""}`,onClick:()=>l("cash"),children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(xe,{className:"w-5 h-5 mr-3 text-gray-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Efectivo"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Pago en efectivo"})]})]})}),e.jsxs("div",{className:`border rounded-lg p-4 cursor-pointer ${t==="mercadopago"?"border-[#2d219b] bg-[#2d219b]/5":""}`,onClick:()=>l("mercadopago"),children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(C,{className:"w-5 h-5 mr-3 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"MercadoPago"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Pago con tarjeta, transferencia o QR"})]})]}),e.jsx("div",{className:"mt-3 p-2 bg-blue-50 rounded text-xs text-blue-700",children:"Método recomendado - Acepta todos los medios de pago"})]}),e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer ${t==="paypal"?"border-[#2d219b] bg-[#2d219b]/5":""}`,onClick:()=>l("paypal"),children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(C,{className:"w-5 h-5 mr-3 text-blue-700"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"PayPal"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Pago con PayPal o tarjeta"})]})]})})]}),t==="mercadopago"&&e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-blue-50 border-blue-200",children:[e.jsxs("div",{className:"flex items-center mb-3",children:[e.jsx(C,{className:"w-5 h-5 mr-2 text-blue-500"}),e.jsx("h4",{className:"font-medium text-blue-700",children:"Pago con MercadoPago"})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx("p",{className:"text-sm text-blue-600",children:"Al continuar serás redirigido a la plataforma segura de MercadoPago donde podrás:"}),e.jsxs("ul",{className:"text-sm text-blue-600 list-disc pl-5 space-y-1",children:[e.jsx("li",{children:"Pagar con tarjeta de crédito o débito"}),e.jsx("li",{children:"Transferencia bancaria"}),e.jsx("li",{children:"Pagar con QR desde tu aplicación móvil"}),e.jsx("li",{children:"Usar el saldo de tu cuenta MercadoPago"})]})]}),e.jsx("p",{className:"text-xs text-blue-500",children:"Serás retornado automáticamente a esta pantalla cuando completes el pago"})]}),t==="paypal"&&e.jsxs("div",{className:"mt-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(be,{amount:(R/800).toFixed(2),currency:"USD",intent:"capture"})}),e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Conversión aproximada: 1 USD = 800 CLP"})]}),V&&e.jsxs(pe,{variant:"destructive",className:"mt-4",children:[e.jsx(he,{className:"h-4 w-4"}),e.jsx(ue,{children:V})]}),e.jsxs("div",{className:"mt-6 flex justify-between",children:[e.jsx(i,{variant:"outline",onClick:()=>o("customer"),children:"Atrás"}),t!=="paypal"&&e.jsx(i,{onClick:te,disabled:j,children:j?"Procesando...":"Completar pago"})]})]})]})})]})}),e.jsx("div",{className:"col-span-1",children:e.jsxs(K,{className:"shadow",children:[e.jsx(Q,{className:"bg-gradient-to-r from-[#2d219b]/10 to-[#2d219b]/5 pb-4",children:e.jsxs(G,{className:"flex justify-between items-center",children:[e.jsx("span",{children:"Carrito"}),e.jsxs("span",{className:"text-sm bg-[#2d219b] text-white px-2 py-1 rounded",children:[n.length," ítems"]})]})}),e.jsxs(W,{className:"p-0",children:[e.jsx(je,{className:"h-[400px]",children:e.jsx("div",{className:"p-4",children:n.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Z,{className:"w-10 h-10 mx-auto mb-2 opacity-20"}),e.jsx("p",{children:"El carrito está vacío"})]}):e.jsx("div",{className:"space-y-2",children:n.map(s=>e.jsxs("div",{className:"flex justify-between items-center border-b pb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-gray-500",children:s.price.toLocaleString("es-CL",{style:"currency",currency:"CLP"})})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(i,{size:"sm",variant:"outline",className:"h-7 w-7 p-0",onClick:()=>X(s.id,s.quantity-1),children:"-"}),e.jsx("span",{className:"w-5 text-center",children:s.quantity}),e.jsx(i,{size:"sm",variant:"outline",className:"h-7 w-7 p-0",onClick:()=>X(s.id,s.quantity+1),children:"+"})]}),e.jsx(i,{size:"sm",variant:"ghost",className:"h-7 w-7 p-0 text-gray-400",onClick:()=>B(s.id),children:e.jsx(ge,{className:"h-4 w-4"})})]})]},s.id))})})}),e.jsx("div",{className:"p-4 border-t bg-gray-50",children:e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal"}),e.jsx("span",{children:F})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (19%)"}),e.jsx("span",{children:U})]}),e.jsx(Y,{className:"my-2"}),e.jsxs("div",{className:"flex justify-between font-bold",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:q})]})]})})]}),e.jsx(fe,{className:"border-t p-4",children:e.jsx(i,{className:"w-full",disabled:n.length===0||j,onClick:()=>o("payment"),children:n.length===0?"Agregue servicios":"Proceder al pago"})})]})})]})]})})};export{Pe as default};
